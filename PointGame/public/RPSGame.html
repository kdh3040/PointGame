<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, width=device-width" />

  <title>복권 관리자 페이지</title>
  <!-- materialize.css 포함 -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link type="text/css" rel="stylesheet" href="materialize.min.css"  media="screen,projection"/>
  <!-- SyntaxHighlighter 포함 -->
  <link href="shCore.css" rel="stylesheet" type="text/css" />
  <!-- <link href="css/shThemeDefault.css" rel="stylesheet" type="text/css" /> -->
  <link href="shThemeMidnight.css" rel="stylesheet" type="text/css" />
  <style>
    #Summary {font-size: 1.2em; }
    #Summary ul{ margin-left: 32px; }
    #Summary ul li{ list-style: disc; }
    .hint{ border-left: 0.3em #ddd solid; padding-left: 1em; color: #777;}
    .code_block{ background-color: #eee; padding: 5px; }
    table, th, td {
           border: 1px solid #bcbcbc;
         }
         table {
   width: 1000dp;
 }
  </style>

</head>

<body>
  <!-- 상단 네비게이션 -->
  <nav class="indigo">
    <div class="nav-wrapper">
      <div class="container">
        <a href="/" class="breadcrumb">메인 페이지</a>
        <a href="/lottoManager.html" class="breadcrumb">가위바위보 관리자</a>
      </div>
    </div>
  </nav>

  <div class="container center"><br><br>

  </div>

  <!-- 내용영역 -->
  <div class="container" id="CONTENTS">
    <!-- 핵심 -->
    <h3 class="indigo-text center">:+: 가위바위보  :+:</h3>

    <div class="row center">
      <button id="BTN_TEST_CREATE" type="button" class="btn white indigo-text">가위바위보 참가</button>
      <button id="BTN_SELECT_LUCKY" type="button" class="btn white indigo-text">가위바위보 결과</button>
    </div>



  </div>


  <!--Import jQuery before materialize.js-->
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js">
  </script>
  <script type="text/javascript" src="./js/materialize.min.js"></script>
  <script type="text/javascript" src="./js/shCore.js"></script>
  <script type="text/javascript" src="./js/shAutoloader.js"></script>
  <script type="text/javascript">
  // SyntaxHighlighter 설정 (http://alexgorbatchev.com/SyntaxHighlighter)
    SyntaxHighlighter.autoloader(
      'bash shell             ./js/shBrushBash.js',
      'js jscript javascript  ./js/shBrushJScript.js'
    );
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.all()
  </script>

  <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-database.js"></script>
  <script src="./fireinit.js"></script>
  <script type="text/javascript">
  var provider = new firebase.auth.GoogleAuthProvider();

  var isEmpty = function(value){
    if( value == "" || value == null || value == undefined || ( value != null && typeof value == "object" && !Object.keys(value).length ) )
    {
      return true
    }
     else
     {
       return false
     }
   };

  function RPSUser()
  {
    var NickName = 'Zero';
    var Index = '1';
    var Value = 0;
    var RoomNumber = 1;
  }

  var tempData = new Array();
  var tempWinnerData = new Array();
  var tempLooserData = new Array();
  var RPSUserCount  = 1;
  var RPSUserSeries = -1;
  var RPSGameCurSeries = 0;
  var RPSUserStatus;

  $("#BTN_TEST_CREATE").click(function() {

    for(var i = 0; i < 5; i++)
    {
      firebase.database().ref('/RPSUserList/' + i).set(i);
    //  firebase.database().ref('/Users/' + i).remove();
    }

/*
  var tempuserCount = RPSUserCount - 1;
  var tempRoom =   Math.floor(tempuserCount / 2);

    console.log(tempRoom);
    firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + tempuserCount + '/Index/').set(RPSUserCount.toString());
    firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + tempuserCount + '/NickName/').set(RPSUserCount.toString());
    firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + tempuserCount + '/Value/').set(Math.floor(Math.random() * 3) + 1);

    RPSUserCount += 1;
    firebase.database().ref('/RPSUserCount').set(RPSUserCount);
    */
  });


    function GetRPSGame()
    {
      var index = 0;

	  
	   tempData = new Array();
	   tempWinnerData = new Array();
	   tempLooserData = new Array();


      firebase.database().ref('/RPSUserCount').once('value', function(snapshot) {
        var message = snapshot.val();
        RPSUserCount = message;
        RPSUserCount *= 1;

        if(RPSUserCount == 1)
        {
            firebase.database().ref('/RPSGame').remove();  
            firebase.database().ref('/RPSGameSeries').set(-1);
            firebase.database().ref('/RPSUserCount').set(0);
		//	firebase.database().ref('/RPSGameCurSeries').set(RPSUserSeries);
            
        }
        else {

            firebase.database().ref('/RPSGame/' + RPSUserSeries + '/').once('value', function(snapshot) {
              var message = snapshot.val();

                      console.log(RPSUserCount);
                //  console.log(message);

                      for(index = 0; index < Math.floor(RPSUserCount / 2 );index++)
                      {

                        tempData[index * 2] = new RPSUser();
                        tempData[index * 2 + 1] = new RPSUser();


                    //    console.log(isEmpty(message[index][index * 2]));


                        tempData[index].RoomNumber = index;

                        if(isEmpty(message[index][index * 2]))
                        {
                          tempData[index * 2].NickName = 'a1a2';
                          tempData[index * 2].Index = '1234';
                          tempData[index * 2].Value = 0;

                          console.log((tempData[index * 2]));
                        }
                        else {
                          tempData[index * 2] = message[index][index * 2];
                        }

                        if(isEmpty(message[index][index * 2 + 1]))
                        {
                          tempData[index * 2 + 1].NickName = 'a1a2';
                          tempData[index * 2 + 1].Index = '1234';
                          tempData[index * 2 + 1].Value = 0;
                          console.log((tempData[index * 2 + 1]));
                        }
                        else {
                          tempData[index * 2 + 1] = message[index][index * 2 + 1];
                        }

                      }

                        console.log('asd');
                        CheckRPSWinner();

                    });

        }

      });
    }

    function CreateRPSGameRoom()
    {
      var i  = 0;
      firebase.database().ref('/RPSGameSeries').once('value', function(snapshot) {
        var message = snapshot.val();
        RPSUserSeries = message;
		RPSUserSeries *= 1;
		RPSUserSeries = 0;

          firebase.database().ref('/RPSUserList').once('value', function(snapshot) {
            var message = snapshot.val();

            //console.log(Object.keys(message).length);

            firebase.database().ref('/RPSUserCount').set(Object.keys(message).length);

            for(var key in message)
            {
              var tempRoomNumber = Math.floor( i / 2) ;
              var tempRoomPosition = i;


              firebase.database().ref('/Users/'+key + '/FirebaseRPSGameMyRoom').set(tempRoomNumber);
              firebase.database().ref('/Users/'+key + '/FirebaseRPSGameMyPosition').set(tempRoomPosition);

              firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoomNumber + '/' + tempRoomPosition + '/Index/').set(key);
              firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoomNumber + '/' + tempRoomPosition + '/NickName/').set(message[key]);
              firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoomNumber + '/' + tempRoomPosition + '/Value/').set(0);

/*
              firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoomNumber + '/' + tempRoomPosition + '/Index/').set(key);
              firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoomNumber + '/' + tempRoomPosition + '/NickName/').set(message[key]);
              firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoomNumber + '/' + tempRoomPosition + '/Value/').set(Math.floor(Math.random() * 3 + 1));
*/
              i++;
            }

              tempRoomNumber = Math.floor( i / 2) ;

              if(Object.keys(message).length % 2 == 1)
              {
                firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoomNumber + '/' + i + '/Index/').set('1234');
                firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoomNumber + '/' + i + '/NickName/').set("a1a2");
                firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoomNumber + '/' + i + '/Value/').set(0);

                firebase.database().ref('/RPSUserCount').set(Object.keys(message).length + 1);
              }

			  firebase.database().ref('/RPSGameSeries').set(RPSUserSeries);

			  firebase.database().ref('/RPSUserList').remove();
              });
      });
    }

  //GetRPSGame();

  // 1: 가위  2: 바위 3: 보
  // 0 비김 , 1 이김, 2 짐

  function CheckRPSWinner()
  {
    var RoomNumber = 0;
    var result = 0;
    var tempUserCount = 0;
    var tempUserRoomCount = Math.floor(RPSUserCount / 2);

      for(var tempIdx = 0 ; tempIdx < tempUserRoomCount; tempIdx++)
      {

        tempWinnerData[tempIdx] = new RPSUser();
        tempLooserData[tempIdx] = new RPSUser();

        console.log(tempData[tempIdx * 2]);
        if(!isEmpty(tempData[tempIdx * 2]))
        {

          var tempMyValue = tempData[tempIdx * 2].Value;

        //  console.log('tempMyValue ' + tempMyValue);

          if(isEmpty(tempData[tempIdx * 2 + 1]))
          {
            result = 1;
          }
          else {
            if(isEmpty(tempData[tempIdx * 2 + 1].Value))
            {
              result = 1;
            }
            else {
              var tempEnemyValue = tempData[tempIdx * 2 + 1].Value;
            //  console.log('tempEnemyValue ' + tempEnemyValue);
              result = (3 + tempMyValue - tempEnemyValue) % 3;
            }
          }

          if(result == 1)
          {
            tempWinnerData[tempUserCount] = tempData[tempIdx * 2];

			var tempRoomNumber =   Math.floor(tempUserCount / 2);
            firebase.database().ref('/Users/'+tempWinnerData[tempUserCount].Index + '/FirebaseRPSGameMyRoom').set(tempRoomNumber);
            firebase.database().ref('/Users/'+tempWinnerData[tempUserCount].Index + '/FirebaseRPSGameMyPosition').set(tempIdx * 2);

            tempLooserData[tempUserCount] = tempData[tempIdx * 2 + 1];
            firebase.database().ref('/Users/'+tempLooserData[tempUserCount].Index + '/FirebaseRPSGameMyRoom').set(-1);
            firebase.database().ref('/Users/'+tempLooserData[tempUserCount].Index + '/FirebaseRPSGameMyPosition').set(-1);
            tempUserCount++;
          }
          else if (result == 2)
          {
            tempLooserData[tempUserCount] = tempData[tempIdx * 2];
            firebase.database().ref('/Users/'+tempLooserData[tempUserCount].Index + '/FirebaseRPSGameMyRoom').set(-1);
            firebase.database().ref('/Users/'+tempLooserData[tempUserCount].Index + '/FirebaseRPSGameMyPosition').set(-1);

            tempWinnerData[tempUserCount] = tempData[tempIdx * 2 + 1];

			var tempRoomNumber =   Math.floor(tempUserCount / 2);
            firebase.database().ref('/Users/'+tempWinnerData[tempUserCount].Index + '/FirebaseRPSGameMyRoom').set(tempRoomNumber);
            firebase.database().ref('/Users/'+tempWinnerData[tempUserCount].Index + '/FirebaseRPSGameMyPosition').set(tempIdx * 2 + 1);
            tempUserCount++ ;
          }
          else
          {
            firebase.database().ref('/Users/'+tempData[tempIdx * 2].Index + '/FirebaseRPSGameMyRoom').set(-1);
            firebase.database().ref('/Users/'+tempData[tempIdx * 2].Index + '/FirebaseRPSGameMyPosition').set(-1);

            firebase.database().ref('/Users/'+tempData[tempIdx * 2 + 1].Index + '/FirebaseRPSGameMyRoom').set(-1);
            firebase.database().ref('/Users/'+tempData[tempIdx * 2 + 1].Index + '/FirebaseRPSGameMyPosition').set(-1);
          }
        }
      }


      firebase.database().ref('/RPSGame/' + RPSUserSeries).remove();

      RPSUserSeries += 1;

	  if(tempWinnerData.length % 2 == 1)
      {
		tempWinnerData[tempWinnerData.length].NickName = 'a1a2';
		tempWinnerData[tempWinnerData.length].Index = '1234';
		tempWinnerData[tempWinnerData.length].Value = 0;

        tempUserCount++;
       }

	  for(var i = 0; i<tempUserCount; i++)
      {
        var tempRoom =   Math.floor(i / 2);
        firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + i + '/Index/').set(tempWinnerData[i].Index);
        firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + i + '/NickName/').set(tempWinnerData[i].NickName);
        firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + i + '/Value/').set(0);
      }        

	  console.log(tempUserCount);
      firebase.database().ref('/RPSUserCount').set(tempUserCount);

      firebase.database().ref('/RPSGameSeries').set(RPSUserSeries);
  }

  var timer;
  var arrLottoSelectTime = ['05:40:30', '05:41:00', '05:41:30', '05:42:00', '05:42:30', '05:13:00'];
  var arrRPSGAmeStartTime = ['05:40:00', '02:45:30', '02:39:15', '02:39:40', '02:01:15', '02:01:35'];



  Number.prototype.to2 = function(){return this<10?'0'+this:this;};
   Date.prototype.getHMS = function(){
         return this.getHours().to2() + ':' + this.getMinutes().to2() + ':'
              + this.getSeconds().to2();
   }


  function showClock(){
          console.log((new Date()).getHMS());
        if((new Date()).getHMS() === arrRPSGAmeStartTime[0])
        {
           CreateRPSGameRoom();
        }

          for(var i=0; i<6; i++) {
           if((new Date()).getHMS() === arrLottoSelectTime[i])
           {
              GetRPSGame();
           }
        }

          timer = setTimeout(showClock,1000);
      }

showClock();

$("#BTN_SELECT_LUCKY").click(function() {
  CreateRPSGameRoom();
  //GetRPSGame();
});

</script>

</body>

</html>
