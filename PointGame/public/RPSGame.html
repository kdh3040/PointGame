<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, width=device-width" />

  <title>복권 관리자 페이지</title>
  <!-- materialize.css 포함 -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link type="text/css" rel="stylesheet" href="materialize.min.css"  media="screen,projection"/>
  <!-- SyntaxHighlighter 포함 -->
  <link href="shCore.css" rel="stylesheet" type="text/css" />
  <!-- <link href="css/shThemeDefault.css" rel="stylesheet" type="text/css" /> -->
  <link href="shThemeMidnight.css" rel="stylesheet" type="text/css" />
  <style>
    #Summary {font-size: 1.2em; }
    #Summary ul{ margin-left: 32px; }
    #Summary ul li{ list-style: disc; }
    .hint{ border-left: 0.3em #ddd solid; padding-left: 1em; color: #777;}
    .code_block{ background-color: #eee; padding: 5px; }
    table, th, td {
           border: 1px solid #bcbcbc;
         }
         table {
   width: 1000dp;
 }
  </style>

</head>

<body>
  <!-- 상단 네비게이션 -->
  <nav class="indigo">
    <div class="nav-wrapper">
      <div class="container">
        <a href="/" class="breadcrumb">메인 페이지</a>
        <a href="/lottoManager.html" class="breadcrumb">가위바위보 관리자</a>
      </div>
    </div>
  </nav>

  <div class="container center"><br><br>

  </div>

  <!-- 내용영역 -->
  <div class="container" id="CONTENTS">
    <!-- 핵심 -->
    <h3 class="indigo-text center">:+: 가위바위보  :+:</h3>

    <div class="row center">
      <button id="BTN_TEST_CREATE" type="button" class="btn white indigo-text">가위바위보 참가</button>
      <button id="BTN_SELECT_LUCKY" type="button" class="btn white indigo-text">가위바위보 결과</button>
    </div>



  </div>


  <!--Import jQuery before materialize.js-->
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js">
  </script>
  <script type="text/javascript" src="./js/materialize.min.js"></script>
  <script type="text/javascript" src="./js/shCore.js"></script>
  <script type="text/javascript" src="./js/shAutoloader.js"></script>
  <script type="text/javascript">
  // SyntaxHighlighter 설정 (http://alexgorbatchev.com/SyntaxHighlighter)
    SyntaxHighlighter.autoloader(
      'bash shell             ./js/shBrushBash.js',
      'js jscript javascript  ./js/shBrushJScript.js'
    );
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.all()
  </script>

  <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-database.js"></script>
  <script src="./fireinit.js"></script>
  <script type="text/javascript">
  var provider = new firebase.auth.GoogleAuthProvider();

  var isEmpty = function(value){
    if( value == "" || value == null || value == undefined || ( value != null && typeof value == "object" && !Object.keys(value).length ) )
    {
      return true
    }
     else
     {
       return false
     }
   };

  function RPSUser()
  {
    var NickName = 'Zero';
    var Index = '1';
    var Value = 0;
    var RoomNumber = 1;
  }

  var tempData = new RPSUser();
  var tempWinnerData = new RPSUser();
  var RPSUserCount  = 1;
  var RPSUserSeries = 0;
  var RPSUserStatus;

  $("#BTN_TEST_CREATE").click(function() {
    var tempuserCount = RPSUserCount - 1;
    var tempRoom =   Math.floor(tempuserCount / 2);

    console.log(tempRoom);
    firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + tempuserCount + '/Index/').set(RPSUserCount.toString());
    firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + tempuserCount + '/NickName/').set(RPSUserCount.toString());
    firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + tempuserCount + '/Value/').set(Math.floor(Math.random() * 3) + 1);

    RPSUserCount += 1;
    firebase.database().ref('/RPSUserCount').set(RPSUserCount);
  });

  $("#BTN_SELECT_LUCKY").click(function() {
    GetRPSGame();
  });


    function GetRPSGame()
    {
      var index = 0;

      firebase.database().ref('/RPSUserCount').once('value', function(snapshot) {
        var message = snapshot.val();
        RPSUserCount = message;

        firebase.database().ref('/RPSGameSeries').once('value', function(snapshot) {
          var message = snapshot.val();
          RPSUserSeries = message;

          firebase.database().ref('/RPSGame/' + RPSUserSeries + '/').once('value', function(snapshot) {
            var message = snapshot.val();

            console.log(RPSUserCount);
      //  console.log(message);

            for(index = 0; index < Math.floor(RPSUserCount / 2) ;index++)
            {
              if(!isEmpty(message[index]))
              {
                      console.log(index);
                tempData[index] = message[index];

                tempData[index].RoomNumber = index;
              }

              else {

                tempData[index][index * 2 + 1].NickName = '부전승';
                tempData[index][index * 2 + 1].Index = '0';
                tempData[index][index * 2 + 1].Value = 0;

                console.log(tempData[index]);
                tempData[index].RoomNumber = index;
              }
            }

              console.log('asd');
              CheckRPSWinner();

          });
        });
      });
    }

  //GetRPSGame();

  // 1: 가위  2: 바위 3: 보
  // 0 비김 , 1 이김, 2 짐

  function CheckRPSWinner()
  {
    var RoomNumber = 0;
    var result = 0;
    var tempUserCount = 0;
    var tempUserRoomCount = Math.floor(RPSUserCount / 2);

      for(var tempIdx = 0 ; tempIdx < tempUserRoomCount; tempIdx++)
      {
        if(!isEmpty(tempData[tempIdx]))
        {
          var tempMyValue = tempData[tempIdx][tempIdx * 2].Value;

        //  console.log('tempMyValue ' + tempMyValue);

          if(isEmpty(tempData[tempIdx][tempIdx * 2 + 1]))
          {
            result = 1;
          }
          else {
            if(isEmpty(tempData[tempIdx][tempIdx * 2 + 1].Value))
            {
              result = 1;
            }
            else {
              var tempEnemyValue = tempData[tempIdx][tempIdx * 2 + 1].Value;
            //  console.log('tempEnemyValue ' + tempEnemyValue);
              result = (3 + tempMyValue - tempEnemyValue) % 3;
            }
          }

          if(result == 1)
          {
            tempWinnerData[tempUserCount] = tempData[tempIdx][tempIdx * 2];
            firebase.database().ref('/Users/'+tempWinnerData[tempUserCount].Index + '/FirebaseRPSGameMyRoom').set(tempUserCount);
            tempUserCount++ ;
          }
          else if (result == 2)
          {
            tempWinnerData[tempUserCount] = tempData[tempIdx][tempIdx * 2 + 1];
            firebase.database().ref('/Users/'+tempWinnerData[tempUserCount].Index + '/FirebaseRPSGameMyRoom').set(tempUserCount);
            tempUserCount++ ;
          }
          else
          {

          }
        }
      }

      firebase.database().ref('/RPSGame/' + RPSUserSeries).remove();
      RPSUserSeries += 1;
      firebase.database().ref('/RPSGameSeries').set(RPSUserSeries);

      console.log(tempUserCount);
      firebase.database().ref('/RPSUserCount').set(tempUserCount);

      for(var i = 0; i<tempUserCount; i++)
      {
        var tempRoom =   Math.floor(i / 2);
        firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + i + '/Index/').set(tempWinnerData[i].Index);
        firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + i + '/NickName/').set(tempWinnerData[i].NickName);
        firebase.database().ref('/RPSGame/' + RPSUserSeries + '/' + tempRoom + '/' + i + '/Value/').set(Math.floor(Math.random() * 3) + 1);
      }
  }



</script>

</body>

</html>
