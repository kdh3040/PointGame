<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>복권 관리자 페이지</title>
  <!-- materialize.css 포함 -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
  <!-- SyntaxHighlighter 포함 -->
  <link href="css/shCore.css" rel="stylesheet" type="text/css" />
  <!-- <link href="css/shThemeDefault.css" rel="stylesheet" type="text/css" /> -->
  <link href="css/shThemeMidnight.css" rel="stylesheet" type="text/css" />
  <style>
    #Summary {font-size: 1.2em; }
    #Summary ul{ margin-left: 32px; }
    #Summary ul li{ list-style: disc; }
    .hint{ border-left: 0.3em #ddd solid; padding-left: 1em; color: #777;}
    .code_block{ background-color: #eee; padding: 5px; }
    table, th, td {
           border: 1px solid #bcbcbc;
         }
         table {
   width: 1000px;
 }
  </style>

</head>

<body>
  <!-- 상단 네비게이션 -->
  <nav class="indigo">
    <div class="nav-wrapper">
      <div class="container">
        <a href="/" class="breadcrumb">메인 관리자</a>
        <a href="/lottoManager.html" class="breadcrumb">복권 관리자</a>
      </div>
    </div>
  </nav>

  <div class="container center"><br><br>

  </div>

  <!-- 내용영역 -->
  <div class="container" id="CONTENTS">
    <!-- 핵심 -->
    <h3 class="indigo-text center">:+: 복권 당첨자 내역 :+:</h3>
<!--
    <div class="row center">
      <button id="BTN_SELECT_LUCKY" type="button" class="btn white indigo-text">당첨 번호 추첨</button>
      <button id="BTN_TEST_CREATE" type="button" class="btn white indigo-text">번호 생성</button>
    </div>
-->
    <div class="row z-depth-1">
      <div class="col l12 m12 s12">
        <p>
        최근 당첨 번호 :
          <!-- TODO 4. 상태 보기용 span 확인-->
           <span id="LOTTO_GROUP" class="blue-text">추첨 버튼을 눌러주세요</span>
         </p>
      </div>
    </div>

    <table>
      <thead>
        <th>회차</th>
        <th>당첨자</th>
        <th>지급 유무</th>
      </thead>
      <tbody id="my-tbody"></tbody>
    </table>
  </div>






  <!--Import jQuery before materialize.js-->
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js">
  </script>
  <script type="text/javascript" src="./js/materialize.min.js"></script>
  <script type="text/javascript" src="./js/shCore.js"></script>
  <script type="text/javascript" src="./js/shAutoloader.js"></script>
  <script type="text/javascript">
  // SyntaxHighlighter 설정 (http://alexgorbatchev.com/SyntaxHighlighter)
    SyntaxHighlighter.autoloader(
      'bash shell             ./js/shBrushBash.js',
      'js jscript javascript  ./js/shBrushJScript.js'
    );
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.all()
  </script>

  <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-database.js"></script>



  <script type="text/javascript">


  var config = {
    apiKey: "AIzaSyAjp9nSk0Ah1SrZXIcNfNpKJF-RIxkt3zM",
    authDomain: "pointgame-2177a.firebaseapp.com",
    databaseURL: "https://pointgame-2177a.firebaseio.com",
    projectId: "pointgame-2177a",
    storageBucket: "pointgame-2177a.appspot.com",
    messagingSenderId: "996170955465"
  };
  firebase.initializeApp(config);

    $("#PROGRESS").show();

      var Lottocount;
      firebase.database().ref('/LottoCount').once('value', function(snapshot) {
        var message = snapshot.val();
        Lottocount = message;
        console.log(Lottocount);
      });

      firebase.database().ref('/Lotto/2_L').once('value', function(snapshot) {
        var message = snapshot.val();
        console.log(snapshot);


      });

	  var LottoRefNumber;
	  firebase.database().ref('/LottoRefNumber').once('value', function(snapshot) {
        var message = snapshot.val();
        LottoRefNumber = message;
        console.log(LottoRefNumber);
      });

      var arrLottoUser = {}//new Array();
      var arrLottoUserKey = new Array();

      var LottoCurSeries;

      firebase.database().ref('/LottoCurSeries').once('value', function(snapshot) {
        var message = snapshot.val();
        LottoCurSeries = message;

        LottoCurSeries = 2;
        console.log('/Lotto/'+LottoCurSeries+'_L');

        var tempIdx = 0;
          var dbTestRef = firebase.database().ref('/Lotto/'+LottoCurSeries+'_L')
          dbTestRef.on('child_added', function(data){

            console.log(data.val(), 'key: ', data.key)
            arrLottoUser[data.key] = data.val();
            arrLottoUserKey[tempIdx] = data.key;
            tempIdx++;
            console.log(arrLottoUserKey);

            $("#LOTTO_GROUP").text(data.val());
          })


        console.log(LottoCurSeries);
      });

      var LottoTodaySeries;
      firebase.database().ref('/LottoTodaySeries').once('value', function(snapshot) {
        var message = snapshot.val();
        LottoTodaySeries = message;
        console.log(LottoTodaySeries);
      });

function SetData(Index, data)
{
  var my_tbody = document.getElementById('my-tbody');
  // var row = my_tbody.insertRow(0); // 상단에 추가
  var row = my_tbody.insertRow( my_tbody.rows.length ); // 하단에 추가
  var cell1 = row.insertCell(0);
  var cell2 = row.insertCell(1);
  var cell3 = row.insertCell(2);
  cell1.innerHTML = Index;
  cell2.innerHTML = data.val();
  cell3.innerHTML = '지급';
}


                var tempIdx = 0;
                  var dbTestRef = firebase.database().ref('/LottoLuckyGroup')
                  dbTestRef.on('child_added', function(data){

                    SetData(tempIdx, data);
                    tempIdx ++;
                  });

                  var tempWinIndex = 0;
                    var dbTestRef = firebase.database().ref('/LottoWinUsers')
                    dbTestRef.on('child_added', function(data){

                      console.log(data.key);
                      console.log(data.val());

                      /*
                      var my_tbody = document.getElementById('my-tbody');
                      // var row = my_tbody.insertRow(0); // 상단에 추가
                      var row = my_tbody.insertRow( my_tbody.rows.length ); // 하단에 추가
                      var cell1 = row.insertCell(0);
                      var cell2 = row.insertCell(1);
                      var cell3 = row.insertCell(2);
                      cell1.innerHTML = tempWinIndex;
                      cell2.innerHTML =  data.val();
                      cell3.innerHTML = data.val();
                      tempWinIndex++;
                      */
                    });


    $("#BTN_SELECT_LUCKY").click(function() {
      var result = Math.floor(Math.random() * arrLottoUserKey.length) + 1;
      result = arrLottoUserKey[result];

    //  document.write(result);
      $("#LOTTO_GROUP").text(arrLottoUser[result]);
       console.log(result);

   firebase.database().ref('/LottoLuckyNumber/'+LottoCurSeries+'_L').set(arrLottoUser[result])
   firebase.database().ref('/LottoLuckyGroup/'+LottoCurSeries+'_L').set(result)

   var LottoRandNumber = Math.floor(Math.random() * 100) + 1;
   firebase.database().ref('/LottoRefNumber').set(LottoRandNumber)

   firebase.database().ref('/Lotto/'+LottoCurSeries+'_L').remove();
   LottoCurSeries += 1;
   firebase.database().ref('/LottoCurSeries').set(LottoCurSeries)
    });




    $("#BTN_TEST_CREATE").click(function() {
      var result = LottoRefNumber * Lottocount;
    //  document.write(result);

    firebase.database().ref('/Lotto/' + Lottocount).set({"User": Lottocount, "Number": result})
    Lottocount++;
    firebase.database().ref('/LottoCount').set(Lottocount)
    });


    var arrLottoSelectTime = ['00:00:00', '09:00:00', '12:00:00', '15:00:00', '18:00:00'];



    Number.prototype.to2 = function(){return this<10?'0'+this:this;};
     Date.prototype.getHMS = function(){
           return this.getHours().to2() + ':' + this.getMinutes().to2() + ':'
                + this.getSeconds().to2();
     }

     function ResetLotto(){
            LottoTodaySeries += 1;
            firebase.database().ref('/LottoTodaySeries').set(LottoTodaySeries)
     }



     function GetLotto(){
             console.log('지금 시각 : ' + (new Date()).getHMS() );
            //arrLottoUserKey = object.keys(arrLottoUser);

             var result = Math.floor(Math.random() * arrLottoUserKey.length) + 1;
             result = arrLottoUserKey[result];

           //  document.write(result);
             $("#LOTTO_GROUP").text(arrLottoUser[result]);
              console.log(result);

          firebase.database().ref('/LottoLuckyNumber/'+LottoCurSeries+'_L').set(arrLottoUser[result])
          firebase.database().ref('/LottoLuckyGroup/'+LottoCurSeries+'_L/'+result).set(arrLottoUser[result])

          var LottoRandNumber = Math.floor(Math.random() * 100) + 1;
          firebase.database().ref('/LottoRefNumber').set(LottoRandNumber)

          firebase.database().ref('/Lotto/'+LottoCurSeries+'_L').remove();
          LottoCurSeries += 1;
          firebase.database().ref('/LottoCurSeries').set(LottoCurSeries)
     }

     function GetTime(){
     //        var 자정='00:00:00';
           var time ='16:01:00';

           if((new Date()).getHMS() == arrLottoSelectTime[0])
           {
               ResetLotto();
           }

           else {
             for(var i=1; i<arrLottoSelectTime.length; i++) {
              //console.log(arrLottoSelectTime[i]);

              if((new Date()).getHMS() == arrLottoSelectTime[i])
              {
                  GetLotto();
              }
             }
           }


          window.setTimeout(GetTime,1000); // 1초마다 반복
     }
     GetTime();


</script>

</body>

</html>
